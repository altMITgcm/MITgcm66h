
Instruction for setting up and running the coupled coarse-resolution
MIT-UCLA ocean (4x4-deg) atmosphere (4x5-deg) model on Columbia.

  ssh menemenl@lou.nas.nasa.gov
  cd /u/menemenl/coupled/coupled2
  dmget camel_7.2p_linux_071005.tar
  scp camel_7.2p_linux_071005.tar lomax:/nobackup1/menemenl

  ssh menemenl@columbia4.nas.nasa.gov
  module switch intel-comp.7.1.032 intel-comp.8.1.024
  cd /nobackup/menemenl/coupled
  tar xvf camel_7.2p_linux_071005.tar
  mv camel_7.2p_linux_071005 camel_7.2p
  cvs co -r release1_coupled MITgcm_code
  cvs co -r release1_coupled MITgcm/verification/coupled_ucla

First a test of the ocean model alone:

  cd MITgcm
  mkdir bin exe
  cd bin
  cp ../verification/coupled_ucla/code/*.h .
  ../tools/genmake -mpi -platform=columbia -makefile
  make depend
  make -j
  cd ../exe
  cp -f ../verification/coupled_ucla/input/* .
  ln -sf data.coupled_debug data
  ln -sf data.pkg.nokpp data.pkg
  ln -sf data.gmredi.gkw91 data.gmredi
  ln -sf POLY3.COEFFS.15 POLY3.COEFFS
  qsub submit.test

Comparison output:

  cmp Eta.*10.data ../verification/coupled_ucla/results/Eta.*

Instructions for creating ocean library for 4x4, 4cpu ocean model:
  cd ../bin
  \rm *
  cp ../verification/coupled_ucla/code/SIZE.h .
  cp ../verification/coupled_ucla/code/GMREDI_OPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_EEOPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_OPTIONS.h.coupled_nokpp CPP_OPTIONS.h
  ../tools/genmake -mpi -platform=columbia -makefile
  make depend
  make -j
  rm -f libocean.a
  ar r libocean.a *.o
  chmod 644 libocean.a
  \cp libocean.a ../../camel_7.2p/esm/lib/

Compile AGCM code
  cd ../..
  mkdir data
  cd camel_7.2p
  source cshrc.setup
  make clean
  make
  make link

Now the moment of truth
  cd bin
  \cp ../../MITgcm/verification/coupled_ucla/input/eedata .
  \cp ../../MITgcm/verification/coupled_ucla/input/data.coupled_90x40 data
  \cp ../../MITgcm/verification/coupled_ucla/input/data.pkg.nokpp data.pkg
  \cp ../../MITgcm/verification/coupled_ucla/input/data.gmredi.gkw91 data.gmredi
  \cp ../../MITgcm/verification/coupled_ucla/input/POLY3.COEFFS.15 POLY3.COEFFS
  \cp ../../MITgcm/verification/coupled_ucla/input/bathymetry.bin .
  \cp ../../MITgcm/verification/coupled_ucla/input/lev_?.bin .
  \cp ../../MITgcm/verification/coupled_ucla/input/trenberth_tau* .
  \cp ../../MITgcm/verification/coupled_ucla/input/ncep_* .
  qsub submit.columbia

##############################################################
##############################################################
##############################################################
##############################################################

Instruction for setting up and running the coupled coarse-resolution
MIT-UCLA ocean (4x4-deg) atmosphere (4x5-deg) model on lomax.

  ssh menemenl@lou.nas.nasa.gov
  cd /u/menemenl/coupled/coupled2
  dmget camel_7.2p_042903.tar
  scp camel_7.2p_042903.tar lomax:/nobackup1/menemenl

  ssh menemenl@lomax.nas.nasa.gov
  cd /nobackup1/menemenl
  tar xvf camel_7.2p_042903.tar
  mv camel_7.2p_042903 camel_7.2p
  cvs co -r release1_coupled MITgcm_code
  cvs co -r release1_coupled MITgcm/verification/coupled_ucla

First a test of the ocean model alone:

  cd MITgcm
  mkdir bin exe
  cd bin
  cp ../verification/coupled_ucla/code/*.h .
  ../tools/genmake -mpi -platform=ames_dbg -makefile
  make depend
  make
  cd ../exe
  cp -f ../verification/coupled_ucla/input/* .
  ln -sf data.coupled_debug data
  ln -sf data.pkg.nokpp data.pkg
  ln -sf data.gmredi.gkw91 data.gmredi
  ln -sf POLY3.COEFFS.15 POLY3.COEFFS
  mpirun -np 4 mitgcmuv

Comparison output:

  cmp Eta.*10.data ../verification/coupled_ucla/results/Eta.*

Instructions for creating ocean library for 4x4, 4cpu ocean model:
  cd ../bin
  \rm *
  cp ../verification/coupled_ucla/code/SIZE.h .
  cp ../verification/coupled_ucla/code/GMREDI_OPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_EEOPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_OPTIONS.h.coupled_nokpp CPP_OPTIONS.h
  ../tools/genmake -mpi -platform=ames_opt -makefile
  make depend
  make
  rm -f libocean.a
  ar r libocean.a *.o
  chmod 644 libocean.a
  \cp libocean.a ../../camel_7.2p/esm/lib/

Get some AGCM configuration files
  cd ../..
  mkdir data
  cd camel_7.2p
  \cp ../MITgcm/verification/coupled_ucla/input/cshrc.setup .
  \cp ../MITgcm/verification/coupled_ucla/input/esminput bin
  \cp ../MITgcm/verification/coupled_ucla/input/esm_input bin
  \cp ../MITgcm/verification/coupled_ucla/input/UserOptions.h include

Set the correct paths and model configuration in following files
  emacs cshrc.setup bin/esminput include/UserOptions.h

Replace "format" with "Format" in some files so that "m4"
preprocessor leaves them untouched.
  sed 's/format/Format/g' esm/service/bc_for_subdomains_shm.FM > tmp
  \mv tmp esm/service/bc_for_subdomains_shm.FM
  sed 's/format(/Format(/g' agcm/llnl/communications/agcm_field_g2s.FM > tmp
  \mv tmp agcm/llnl/communications/agcm_field_g2s.FM
  sed 's/format(/Format(/g' agcm/llnl/communications/agcm_field_s2g.FM > tmp
  \mv tmp agcm/llnl/communications/agcm_field_s2g.FM
  sed 's/format(/Format(/g' agcm/llnl/tmpx/agcm_field_g2s.FM > tmp
  \mv tmp agcm/llnl/tmpx/agcm_field_g2s.FM
  sed 's/format(/Format(/g' agcm/llnl/tmpx/agcm_field_s2g.FM > tmp
  \mv tmp agcm/llnl/tmpx/agcm_field_s2g.FM
  sed 's/format(/Format(/g' agcm/llnl/tmpx/agcm_init2.FM > tmp
  \mv tmp agcm/llnl/tmpx/agcm_init2.FM

Compile code
  module switch MIPSpro MIPSpro.7.3.1.1
  module switch mpt mpt.1.4.0.0
  source cshrc.setup
  mkmf
  make clean
  make
  make link

Now the moment of truth
  cd bin
  ln -sf ../../MITgcm/verification/coupled_ucla/input/* .
  ln -sf data.coupled_90x40 data
  ln -sf data.pkg.nokpp data.pkg
  ln -sf data.gmredi.gkw91 data.gmredi
  ln -sf POLY3.COEFFS.15 POLY3.COEFFS
  rm -f output.txt STD*
  qsub submit.lomax

##############################################################
##############################################################
##############################################################
##############################################################







Moving to a new path:
  cd coupled2/camel_7.2p
  emacs include/UserOptions.h
  emacs bin/esminput
  emacs cshrc.setup
  module switch MIPSpro MIPSpro.7.3.1.1m
  module switch mpt mpt.1.4.0.0
  source cshrc.setup
  cd esm/service
  make
  cd ../..
  make link
  cd bin
  qsub submit

Notes:

The path in cshrc.setup cannot be too long or  it won't work.

On May 7, 2003 we were running:

turing -- MIPSpro.7.3.1.1m
          mpt.1.4.0.0
          scsl.1.2.0.0

However, since you can't run anything substantial on turing, here's
the information for lomax and chapman.

lomax -- MIPSpro.7.3.1.1m
         mpt.1.5.3.0
         scsl.1.2.0.0

chapman -- MIPSpro.7.3.1.1m.libmp-fix
           mpt.1.6.1.beta
           scsl.1.3.0.0

Remember that you will need to use the "module switch ..." command
for both compiling and running since there are many run-time libraries
that will need to be consistent with the build environment.

===================================================================
===================================================================
===================================================================

before starting, on alhena use:

source /opt/modules/modules/init/tcsh
module load modules
module load MIPSpro.73

===================================================================

explicit paths in coupled model is in:
./include/UserOptions.h
#define ESM_INPUT_FILE "/u/menemenl/camel_7.2p/bin/esm_input"

then:
 cd ./esm/service
 make

also in ./bin/esminput
 FE_datdir='/nobackup2/menemenl/coupled2/data',
 FE_mssdir='/nobackup2/menemenl/coupled2/data',

and in cshrc.setup
setenv CAMILLEHOME /nobackup2/menemenl/coupled2/camel_7.2p

===================================================================

esm_input : 16 4  -> atmospheric CPUs + 1; oceanic CPUs

esminput:

 tbegin=1835.0,   -> time in days from 0000 (Jan. 10, 0005 00:00 GMT)
 tfinal=2017.5,   -> 1/2-year, 182.5-day integration
 year0=5, day0=10, hour0=00.0, seconds0=0.0,
                  -> this is the reference date relative to which
                     OD_dtom, dt_agcmedit, and dt_agcmhist_outcoupling
                     are computed
 GM_run=0,        -> no AGCM output to FE_datdir
 GM_run=1,        -> allow AGCM output to FE_datdir
 OD_dtom=6.0,     -> coupling interval in hours

 NP_agcm=6,       -> total # of atmospheric CPUs
 NPI_agcm=2,      -> x-direction CPUS, better if rather small
 NPJ_agcm=3,      -> y-direction CPUS
 dt_agcmedit=864000.0,      -> interval for diagnostic averages (s)
 dt_agcmhist_out=5184000.0, -> atmosphere model checkpointing (s)

===================================================================

 C   8 Calling G2OEIU  timestamp= 18:16:46                        44046.00
 C   1 Calling G2OEIU  timestamp= 18:16:50                        44049.00
 C   1 Exiting G2OEIU  timestamp= 18:16:50                            0
 C   8 Exiting G2OEIU  timestamp= 18:16:50                            0
 C   8 Calling O2GEIU  timestamp= 18:16:58                        44049.00
 C   8 Exiting O2GEIU  timestamp= 18:16:58            
 C   1 Calling O2GEIU  timestamp= 18:16:58                        44052.00
 C   1 Exiting O2GEIU  timestamp= 18:16:58            

Note, G2OEIU means AGCM to OGCM.  O2GEIU means OGCM to AGCM.  This particular
example, a 7-CPU atmosphere and a 56-CPU ocean, shows that the ocean model,
process 8, needs to wait for 4 seconds for the atmosphere model, process 1, to
provide it with data.  While the atmosphere model receives data right away
from the ocean.  So the atmosphere is slower than the ocean and needs to
allocated more CPUs.

===================================================================

This is a 4-CPU experiment, which is based on global_ocean.90x40x15.

Instructions for running verification/coupled_ucla:
  cd MITgcm/bin
  cp ../verification/coupled_ucla/code/*.h .
  ../tools/genmake -mpi -makefile
    ==> on alhena use:
      ../tools/genmake -mpi -platform=o2k -makefile
    ==> on turing use:
      ../tools/genmake -mpi -platform=ames_dbg -makefile
  make depend
  make
  cd ../exe
  cp -f ../verification/coupled_ucla/input/* .
  ln -sf data.coupled_debug data
  ln -sf data.pkg.nokpp data.pkg
  ln -sf data.gmredi.gkw91 data.gmredi
  ln -sf POLY3.COEFFS.15 POLY3.COEFFS
  mpirun -np 4 mitgcmuv

Comparison output:
  cmp Eta.*10.data ../verification/coupled_ucla/results/Eta.*

===================================================================

Instructions for creating library for 4x4, 4cpu ocean model:
  cd MITgcm/bin
  cp ../verification/coupled_ucla/code/SIZE.h .
  cp ../verification/coupled_ucla/code/GMREDI_OPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_EEOPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_OPTIONS.h.coupled_nokpp CPP_OPTIONS.h
  ../tools/genmake -mpi -makefile
==> on alhena and turing use:
  ../tools/genmake -mpi -platform=ames_opt -makefile
  make depend
  make
  rm -f libocean.a
  ar r libocean.a *.o
  chmod 644 libocean.a
==> then copy or link libocean.a to camel_7.2p/esm/lib
==> go to camel_7.2p directory
  cd camel_7.2p
  source cshrc.setup
  make link
  cd bin
==> copy release1_coupled/verification/coupled_ucla/input/* to camel_7.2p/bin
  ln -sf data.coupled_90x40 data
  ln -sf data.pkg.nokpp data.pkg
  ln -sf data.gmredi.gkw91 data.gmredi
  ln -sf POLY3.COEFFS.15 POLY3.COEFFS
  rm -f output.txt STD*
  
  mpirun -np 20 camel2 >& output.txt


===================================================================

Instructions for creating library for JPL-ECCO-1/3-deg, 64cpu ocean model:
  cd MITgcm/bin
  cp ../verification/coupled_ucla/code/SIZE.h.64 SIZE.h
  cp ../verification/coupled_ucla/code/GMREDI_OPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_EEOPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_OPTIONS.h.coupled_kpp CPP_OPTIONS.h
  ../tools/genmake -mpi -makefile
==> on alhena and turing use:
  ../tools/genmake -mpi -platform=ames_opt -makefile
  make depend
  make
  rm -f libocean.a
  ar r libocean.a *.o
  chmod 644 libocean.a
==> then copy or link libocean.a to camel_7.2p/esm/lib
==> go to camel_7.2p directory
  cd camel_7.2p
  source cshrc.setup
  make link
  cd bin
==> copy release1_coupled/verification/coupled_ucla/input/* to camel_7.2p/bin
  ln -sf data.coupled_360x224 data
  ln -sf data.pkg.kpp data.pkg
  ln -sf data.gmredi.ldd97 data.gmredi
  ln -sf POLY3.COEFFS.46 POLY3.COEFFS
  rm -f output.txt STD*
  mpirun -np 80 camel2 >& output.txt


===================================================================

Hi-res ocean, low-res atmosphere on 64-CPU:
Note that with 1-hour time steps, ocean model fails after 35 days.

  ssh gemini.jpl.nasa.gov
  cd /tmp1/dmenem
  mkdir oldpbl
  cd oldpbl
  dmget /silo/dmenem/coupled/camel_7.2p_042903.tar
  tar xvf /silo/dmenem/coupled/camel_7.2p_042903.tar
  mitcvs co -r release1_coupled MITgcm
  cd MITgcm/bin
  cp ../verification/coupled_ucla/code/SIZE.h.56 SIZE.h
  cp ../verification/coupled_ucla/code/GMREDI_OPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_EEOPTIONS.h .
  cp ../verification/coupled_ucla/code/CPP_OPTIONS.h.coupled_kpp CPP_OPTIONS.h
  ../tools/genmake -mpi -platform=ames_opt -makefile
  make depend
  make
  rm -f libocean.a
  ar r libocean.a *.o
  chmod 644 libocean.a
  cp libocean.a ../../camel_7.2p_042903/esm/lib/
  cd ../../camel_7.2p_042903
  cp ../MITgcm/verification/coupled_ucla/input/UserOptions.h include
  cp ../MITgcm/verification/coupled_ucla/input/cshrc.setup .
  source cshrc.setup
  make clean
  make
  cd bin
  cp ../../MITgcm/verification/coupled_ucla/input/* .
  cp data.coupled_360x224 data
  cp data.pkg.kpp data.pkg
  cp data.gmredi.ldd97 data.gmredi
  cp POLY3.COEFFS.46 POLY3.COEFFS
  cp esm_input.56 esm_input
  cp esminput.56 esminput

Submitting a job on alhena:

  cd /alhena/tmp1/dmenem
  mv oldpbl recycle_bin
  mkdir oldpbl
  cd oldpbl
  mkdir data
  mkdir camel_7.2p_042903
  cd camel_7.2p_042903
  cp -r /tmp1/dmenem/oldpbl/camel_7.2p_042903/bin .
  cd bin
  qsub submit.long64a

Submitting a job on castor:

  cd /castor/tmp1/dmenem
  mv oldpbl recycle_bin
  mkdir oldpbl
  cd oldpbl
  mkdir data
  mkdir camel_7.2p_042903
  cd camel_7.2p_042903
  cp -r /tmp1/dmenem/oldpbl/camel_7.2p_042903/bin .
  cd bin
  qsub submit.long64c

Submitting a job on pollux:

  cd /pollux/tmp1/dmenem
  mv oldpbl recycle_bin
  mkdir oldpbl
  cd oldpbl
  mkdir data
  mkdir camel_7.2p_042903
  cd camel_7.2p_042903
  cp -r /tmp1/dmenem/oldpbl/camel_7.2p_042903/bin .
  cd bin
  qsub submit.long64p

Chaining a job starting on OGCM day 180, AGCM day 2015 on castor:

  cd /castor/tmp1/dmenem/oldpbl/camel_7.2p_042903/bin
  rm -f data tmp tmp1 tmp2 esminput
  sed -e "s/startTime   = 0.0/startTime=15768000./" data.coupled_360x224 > data
  sed -e "s/tbegin=1835.0/tbegin=2017.5/" esminput.56 > tmp
  sed -e "s/tfinal=2017.5/tfinal=2200.0/" tmp > tmp1
  sed -e "s/'agcm_infile'/'E231_new_PAC__hist001.nc'/" tmp1 > esminput
  qsub submit.long64c
